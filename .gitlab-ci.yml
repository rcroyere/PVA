stages:
  - test
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

before_script:
  - python -V
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
  - pip install -r requirements.txt

# Tests unitaires
unit_tests:
  stage: test
  script:
    - pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week

# Tests de connectivité DEV (automatique sur main)
connectivity_tests_dev:
  stage: test
  only:
    - main
    - develop
  script:
    - python main.py --env dev --all --report-format junit
  artifacts:
    reports:
      junit: reports/*.xml
    paths:
      - reports/
    expire_in: 1 week
  allow_failure: true

# Tests de connectivité QA (manuel)
connectivity_tests_qa:
  stage: test
  when: manual
  only:
    - main
  script:
    - python main.py --env qa --all --report-format junit
  artifacts:
    reports:
      junit: reports/*.xml
    paths:
      - reports/
    expire_in: 1 week

# Tests de connectivité PP (manuel)
connectivity_tests_pp:
  stage: test
  when: manual
  only:
    - main
  script:
    - python main.py --env pp --all --report-format junit
  artifacts:
    reports:
      junit: reports/*.xml
    paths:
      - reports/
    expire_in: 1 week

# Tests de connectivité PROD (manuel + approval)
connectivity_tests_prod:
  stage: test
  when: manual
  only:
    - main
  script:
    - python main.py --env prod --all --report-format junit
  artifacts:
    reports:
      junit: reports/*.xml
    paths:
      - reports/
    expire_in: 1 month
  environment:
    name: production
    action: verify

# Build Docker image
build_docker:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  only:
    - main
    - tags
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest

# Scheduled job pour tests réguliers
scheduled_connectivity_tests:
  stage: test
  only:
    - schedules
  script:
    - python main.py --env dev --all --report-format html
    - python main.py --env qa --all --report-format html
  artifacts:
    paths:
      - reports/
    expire_in: 1 month
  # Notifier sur échec
  after_script:
    - |
      if [ $CI_JOB_STATUS != 'success' ]; then
        echo "Tests de connectivité échoués - Envoyer notification Slack"
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"❌ Tests de connectivité échoués sur '$CI_ENVIRONMENT_NAME'"}' \
        #   $SLACK_WEBHOOK_URL
      fi
